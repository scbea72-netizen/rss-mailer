name: KIS MA20 Close Mail (KR)

on:
  schedule:
    - cron: "40 6 * * 1-5"   # KST 15:40 (UTC 06:40)
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        part: [1, 2, 3, 4]
    timeout-minutes: 20

    env:
      PART_INDEX: ${{ matrix.part }}
      PART_TOTAL: 4

      # ✅ 기존 kis_ma20_close_kr.py가 쓰는 ENV 이름 그대로 맞춤
      KIS_APPKEY: ${{ secrets.KIS_APPKEY }}
      KIS_APPSECRET: ${{ secrets.KIS_APPSECRET }}
      KIS_KOSPI_MST_URL: ${{ secrets.KIS_KOSPI_MST_URL }}
      KIS_KOSDAQ_MST_URL: ${{ secrets.KIS_KOSDAQ_MST_URL }}

      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}
      HANMAIL_TO: ${{ secrets.HANMAIL_TO }}

      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      TOPN: "30"
      VOL_MULT: "0.7"
      NEAR_PCT: "0.012"
      BREAKOUT_LOOKBACK: "3"
      ABOVE_MIN_PCT: "0.003"
      ABOVE_MAX_PCT: "0.05"
      ABOVE_VOL_MULT: "0.6"

      REQ_TIMEOUT: "15"
      MST_TIMEOUT: "60"
      MAX_RETRY: "2"
      RETRY_SLEEP: "0.6"
      SLEEP_EVERY: "25"
      SLEEP_SEC: "0.35"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install deps (KIS)
        run: |
          pip install -r requirements_kis.txt

      - name: Run MA20 Scan (Split)
        run: |
          python kis_ma20_close_kr.py

      - name: Upload partial result
        uses: actions/upload-artifact@v4
        with:
          name: result_part_${{ matrix.part }}
          path: output/result_part_${{ matrix.part }}.json

  merge_send:
    needs: scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}
      HANMAIL_TO: ${{ secrets.HANMAIL_TO }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TOPN: "30"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install deps (KIS)
        run: |
          pip install -r requirements_kis.txt

      - name: Download scan results
        uses: actions/download-artifact@v4
        with:
          path: output

      - name: Merge & Send (Mail + Telegram + Excel)
        run: |
          python merge_and_send.py
