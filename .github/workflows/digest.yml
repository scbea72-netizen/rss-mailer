name: RSS Digest Mailer

on:
  schedule:
    # 30분 간격 (너무 자주 돌리면 캐시 때문에 1~2개만 남기 쉬움)
    - cron: "*/30 * * * *"
  workflow_dispatch:

concurrency:
  group: rss-digest-mailer
  cancel-in-progress: true

jobs:
  send-digest:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore cache (dedupe state)
        uses: actions/cache@v4
        with:
          path: .cache/rss
          key: rss-digest-cache
          restore-keys: |
            rss-digest-cache

      - name: Run digest
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_TO:   ${{ secrets.MAIL_TO }}

          # ✅ 기사 적게 오는 원인 제거(배치 윈도우 기본 OFF)
          BATCH_WINDOW_SECONDS: "0"

          # ✅ 한 통에 많이(국가별 고르게)
          MAX_ITEMS_PER_EMAIL: "120"
          MAX_US: "25"
          MAX_KR: "25"
          MAX_JP: "25"

          # ✅ 피드/기간 여유
          MAX_ITEMS_PER_FEED: "50"
          MAX_AGE_HOURS: "48"

          # ✅ 일본 기사 너무 적으면 키워드 필터 OFF (많이 받기)
          JP_KEYWORD_MODE: "0"

          # (선택) 리다이렉트 최종 URL까지 따라가려면 1
          RESOLVE_FINAL_URL: "0"
        run: |
          python rss_digest.py
