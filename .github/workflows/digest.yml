name: RSS Digest Mailer

on:
  schedule:
    # 45분마다 실행
    - cron: "*/45 * * * *"
  workflow_dispatch:

concurrency:
  group: rss-digest-mailer
  cancel-in-progress: true

jobs:
  send-digest:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore cache (dedupe + title translate)
        uses: actions/cache@v4
        with:
          path: |
            .cache/rss
          key: rss-digest-cache
          restore-keys: |
            rss-digest-cache

      - name: Run digest
        env:
          # 메일 발송 (Secrets에 있어야 함)
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_TO:   ${{ secrets.MAIL_TO }}

          # 안정 옵션
          REQUEST_TIMEOUT: "15"
          BATCH_WINDOW_SECONDS: "0"
          MAX_AGE_HOURS: "48"
          MAX_ITEMS_PER_FEED: "50"

          # 한 통 구성 (국가별 상한)
          MAX_ITEMS_PER_EMAIL: "120"
          MAX_US: "25"
          MAX_KR: "25"
          MAX_JP: "25"

          # ✅ 제목 번역: KR은 그대로, US/JP만 MyMemory로 제목만 한글 번역
          TITLE_TRANSLATE: "1"
          TITLE_TRANSLATE_PROVIDER: "mymemory"
          TRANSLATE_SLEEP_SECONDS: "1.0"

          # 일본 뉴스 필터(많이 받으려면 0)
          JP_KEYWORD_MODE: "0"

          # 최종 URL 추적(기본 OFF)
          RESOLVE_FINAL_URL: "0"
        run: |
          python rss_digest.py

