name: KR Close Scan (Finalists)

on:
  workflow_dispatch:
  schedule:
    # Mon-Fri 15:40 KST = 06:40 UTC
    - cron: "40 6 * * 1-5"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run KR close scan (finalists)
        run: |
          python scan_close_kr.py \
            --min-change 3 \
            --max-change 15 \
            --rsi-min 55 \
            --rsi-max 75 \
            --use-volume \
            --vol-mult 1.3 \
            --top 40 \
            --out-text out/scan_close_kr.txt \
            --out-json out/scan_close_kr.json

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: kr-close-scan
          path: out/

      - name: Telegram notify (debug)
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python - << 'PY'
          import json, os, sys, urllib.parse, urllib.request
          from urllib.error import HTTPError, URLError

          token = (os.getenv("TELEGRAM_BOT_TOKEN") or "").strip()
          chat_id = (os.getenv("TELEGRAM_CHAT_ID") or "").strip()

          print("token_set =", bool(token))
          print("chat_id =", chat_id if chat_id else "(empty)")

          if not token or not chat_id:
              print("Telegram secrets not set. Skip.")
              sys.exit(0)

          p = json.load(open("out/scan_close_kr.json","r",encoding="utf-8"))
          header = p["meta"]["header"]
          items = p.get("items", [])[:5]

          lines = [header, "TOP 5"]
          for i, it in enumerate(items, 1):
              lines.append(f"{i}. {it['name']}({it['code']}) {it['chg%']:.1f}% RSI{it['rsi14']:.0f} S{it['score']}")
          msg = "\n".join(lines)[:2000]

          url = f"https://api.telegram.org/bot{token}/sendMessage"
          data = urllib.parse.urlencode({"chat_id": chat_id, "text": msg}).encode("utf-8")

          try:
              resp = urllib.request.urlopen(url, data=data, timeout=30).read().decode("utf-8", errors="ignore")
              print("Telegram response:", resp[:800])
              print("Telegram sent")
          except HTTPError as e:
              body = e.read().decode("utf-8", errors="ignore")
              print("HTTPError:", e.code, e.reason)
              print("Body:", body[:2000])
          except URLError as e:
              print("URLError:", str(e))
          PY

      - name: Send Gmail (KR close scan)
        continue-on-error: true
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: |
          python - << 'PY'
          import os, smtplib
          from email.mime.text import MIMEText

          user = (os.getenv("GMAIL_USER") or "").strip()
          app  = (os.getenv("GMAIL_APP_PASSWORD") or "").strip()
          to   = (os.getenv("TO_EMAIL") or "").strip()

          if not user or not app or not to:
              print("Gmail secrets not set. Skip.")
              raise SystemExit(0)

          with open("out/scan_close_kr.txt","r",encoding="utf-8") as f:
              body = f.read()

          msg = MIMEText(body, _charset="utf-8")
          msg["Subject"] = "[KR CLOSE SCAN] Finalists"
          msg["From"] = user
          msg["To"] = to

          with smtplib.SMTP_SSL("smtp.gmail.com", 465) as s:
              s.login(user, app)
              s.sendmail(user, [to], msg.as_string())

          print("Gmail sent")
          PY
