name: Radar Alerts

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

concurrency:
  group: radar-alerts
  cancel-in-progress: true

jobs:
  radar:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run radar (Telegram)
        env:
          TG_BOT_TOKEN:  ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID_US: ${{ secrets.TG_CHAT_ID_US }}
          TG_CHAT_ID_JP: ${{ secrets.TG_CHAT_ID_JP }}
          TG_CHAT_ID_KR: ${{ secrets.TG_CHAT_ID_KR }}
        run: |
          python radar.py

      - name: Send Gmail summary (optional)
        continue-on-error: true
        env:
          GMAIL_USER:         ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          TO_EMAIL:           ${{ secrets.TO_EMAIL }}
        run: |
          python - << 'PY'
          import os, smtplib
          from email.mime.text import MIMEText

          user = (os.getenv("GMAIL_USER") or "").strip()
          app  = (os.getenv("GMAIL_APP_PASSWORD") or "").strip()
          to   = (os.getenv("TO_EMAIL") or "").strip()

          if not user or not app or not to:
              print("Gmail secrets not set. Skip.")
              raise SystemExit(0)

          body = "✅ Radar workflow ran. 자세한 건 텔레그램 확인."
          msg = MIMEText(body, _charset="utf-8")
          msg["Subject"] = "[RADAR] 실행 완료"
          msg["From"] = user
          msg["To"] = to

          with smtplib.SMTP_SSL("smtp.gmail.com", 465) as s:
              s.login(user, app)
              s.sendmail(user, [to], msg.as_string())

          print("Gmail sent")
          PY

