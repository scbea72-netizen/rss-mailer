name: Stock Radar (US/JP/KR)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  radar:
    runs-on: ubuntu-latest

    env:
      # ✅ Telegram (승찬님 시크릿 그대로)
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_ID_US: ${{ secrets.TG_CHAT_ID_US }}
      TG_CHAT_ID_JP: ${{ secrets.TG_CHAT_ID_JP }}
      TG_CHAT_ID_KR: ${{ secrets.TG_CHAT_ID_KR }}

      # ✅ 등락률 레이더 파라미터
      PCT_MIN: 0.3
      ABS_MODE: 0

      # ✅ 스캔 파라미터 (전종목이면 BATCH_SIZE 너무 크게 잡지 마세요)
      MAX_TICKERS: 0
      BATCH_SIZE: 80
      RETRY: 2
      SLEEP_BETWEEN_BATCH: 0.4

      # ✅ (선택) 한국 티커에 KONEX 포함하려면 1
      INCLUDE_KONEX: 0
      KR_TICKERS_OUT: tickers_kr.txt

      # ✅ (선택) 상태점검 메시지/로그용
      DEBUG_STATUS: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          # 레이더 기본 의존성
          pip install -r requirements.txt
          # 티커 자동 생성용 (KRX 전종목)
          pip install finance-datareader

      # ✅ 1) 텔레그램 연결 테스트 (US/JP/KR 각각)
      - name: Telegram smoke test (US/JP/KR)
        run: |
          python - <<'PY'
          import os, requests, datetime
          token=os.getenv("TG_BOT_TOKEN","").strip()
          chats={
            "US": os.getenv("TG_CHAT_ID_US","").strip(),
            "JP": os.getenv("TG_CHAT_ID_JP","").strip(),
            "KR": os.getenv("TG_CHAT_ID_KR","").strip(),
          }
          if not token:
              raise SystemExit("❌ TG_BOT_TOKEN missing")
          url=f"https://api.telegram.org/bot{token}/sendMessage"
          now=datetime.datetime.now().strftime("%H:%M:%S")
          for k, chat in chats.items():
              if not chat:
                  print(f"[{k}] ❌ chat_id missing")
                  continue
              r=requests.post(url, data={"chat_id":chat, "text":f"✅ Telegram test ({k}) @ {now}"}, timeout=15)
              print(f"[{k}] status:", r.status_code, (r.text or "")[:200])
          PY

      # ✅ 2) 한국 코스피+코스닥 전종목 티커 자동 생성
      #    (tools/gen_tickers_kr.py 파일이 repo에 있어야 함)
      - name: Build KR tickers (KOSPI+KOSDAQ full)
        run: |
          python tools/gen_tickers_kr.py

      # ✅ 3) 티커 파일 존재/개수 점검 (문제 생기면 여기서 바로 보임)
      - name: Check ticker files
        run: |
          python - <<'PY'
          import os
          for fn in ["tickers_us.txt","tickers_jp.txt","tickers_kr.txt"]:
              if not os.path.exists(fn):
                  print(f"{fn}: MISSING")
                  continue
              with open(fn,"r",encoding="utf-8") as f:
                  lines=[ln.strip() for ln in f if ln.strip() and not ln.strip().startswith("#")]
              print(f"{fn}: {len(lines)} tickers (sample: {lines[:5]})")
          PY

      # ✅ 4) 레이더 실행
      - name: Run radar
        run: python radar.py

