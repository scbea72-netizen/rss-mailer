name: Stock Radar (US/JP/KR)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  radar:
    runs-on: ubuntu-latest

    env:
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_ID_US: ${{ secrets.TG_CHAT_ID_US }}
      TG_CHAT_ID_JP: ${{ secrets.TG_CHAT_ID_JP }}
      TG_CHAT_ID_KR: ${{ secrets.TG_CHAT_ID_KR }}

      PCT_MIN: 3.0
      ABS_MODE: 0
      MAX_TICKERS: 4000
      BATCH_SIZE: 200

      # ✅ 파일/상태 점검용
      DEBUG_STATUS: 1

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ✅ (핵심) US/JP/KR 각각 텔레그램 테스트
      - name: Telegram smoke test (US/JP/KR)
        run: |
          python - <<'PY'
          import os, requests, datetime
          token=os.getenv("TG_BOT_TOKEN","").strip()
          chats={
            "US": os.getenv("TG_CHAT_ID_US","").strip(),
            "JP": os.getenv("TG_CHAT_ID_JP","").strip(),
            "KR": os.getenv("TG_CHAT_ID_KR","").strip(),
          }
          if not token:
              raise SystemExit("❌ TG_BOT_TOKEN missing")
          url=f"https://api.telegram.org/bot{token}/sendMessage"
          now=datetime.datetime.now().strftime("%H:%M:%S")
          for k, chat in chats.items():
              if not chat:
                  print(f"[{k}] ❌ chat_id missing")
                  continue
              r=requests.post(url, data={"chat_id":chat, "text":f"✅ Telegram test ({k}) from GitHub Actions @ {now}"}, timeout=15)
              print(f"[{k}] status:", r.status_code, (r.text or "")[:200])
          PY

      # ✅ 티커 파일 존재/개수 확인 (이거로 KR/JP가 비어있는지 1초컷)
      - name: Check ticker files
        run: |
          python - <<'PY'
          import os
          for fn in ["tickers_us.txt","tickers_jp.txt","tickers_kr.txt"]:
              if not os.path.exists(fn):
                  print(f"{fn}: MISSING")
                  continue
              with open(fn,"r",encoding="utf-8") as f:
                  lines=[ln.strip() for ln in f if ln.strip() and not ln.strip().startswith("#")]
              print(f"{fn}: {len(lines)} tickers (sample: {lines[:5]})")
          PY

      - name: Run radar
        run: python radar.py
