name: KIS MA20 Close Mail (KR)

on:
  workflow_dispatch:
  schedule:
    - cron: "30 6 * * 1-5"  # 평일 15:30 KST (UTC 06:30)

concurrency:
  group: kis-ma20-close
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (KIS only)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_kis.txt

      - name: Check required env
        run: |
          python - << 'PY'
          import os
          keys = [
            "KIS_APPKEY","KIS_APPSECRET","KIS_BASE_URL","KIS_KOSPI_MST_URL","KIS_KOSDAQ_MST_URL",
            "GMAIL_USER","GMAIL_APP_PASS","HANMAIL_TO",
            "TELEGRAM_BOT_TOKEN","TELEGRAM_CHAT_ID"
          ]
          for k in keys:
            v = os.getenv(k, "")
            print(f"{k}={'OK' if v else 'MISSING'}")
          PY
        env:
          KIS_APPKEY: ${{ secrets.KIS_APPKEY }}
          KIS_APPSECRET: ${{ secrets.KIS_APPSECRET }}
          KIS_BASE_URL: ${{ secrets.KIS_BASE_URL }}
          KIS_KOSPI_MST_URL: ${{ secrets.KIS_KOSPI_MST_URL }}
          KIS_KOSDAQ_MST_URL: ${{ secrets.KIS_KOSDAQ_MST_URL }}

          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}
          HANMAIL_TO: ${{ secrets.HANMAIL_TO }}

          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Run MA20 Entry & Send (Mail + Telegram)
        timeout-minutes: 30
        env:
          KIS_APPKEY: ${{ secrets.KIS_APPKEY }}
          KIS_APPSECRET: ${{ secrets.KIS_APPSECRET }}
          KIS_BASE_URL: ${{ secrets.KIS_BASE_URL }}
          KIS_KOSPI_MST_URL: ${{ secrets.KIS_KOSPI_MST_URL }}
          KIS_KOSDAQ_MST_URL: ${{ secrets.KIS_KOSDAQ_MST_URL }}

          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}
          HANMAIL_TO: ${{ secrets.HANMAIL_TO }}

          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          SMTP_HOST: smtp.gmail.com
          SMTP_PORT: "465"

          TOPN: "30"
          VOL_MULT: "1.0"
          NEAR_PCT: "0.005"

          FULL_SCAN: "0"
          TEST_LIMIT: "400"

          REQ_TIMEOUT: "15"
          MAX_RETRY: "2"
          RETRY_SLEEP: "0.6"
          SLEEP_EVERY: "25"
          SLEEP_SEC: "0.35"

        run: |
          python kis_ma20_close_kr.py
